const overboardLink=document.getElementById("overboardlink");if(overboardLink){const e=new URL(overboardLink.href).pathname;(()=>{const t=JSON.parse(localStorage.getItem("overboardsettings"));(t.add.length>0||t.rem.length>0||!t.include_default)&&overboardLink.setAttribute("href",`${e}?${new URLSearchParams(t)}`)})();const t=document.getElementById("overboardform");if(t){const e=()=>{const e={add:t.elements.add.value,rem:t.elements.rem.value,include_default:t.elements.include_default.checked};0!==e.add.length||e.include_default||(e.include_default=!0),setLocalStorage("overboardsettings",JSON.stringify(e))};t.addEventListener("submit",e,!1)}}document.querySelectorAll('input[type="file"]').forEach((e=>{e.style.position="absolute",e.style.border="none",e.style.height="1px",e.style.width="1px"}));class Dragable{constructor(e,t){this.draging=!1,this.xo=0,this.yo=0,this.targetId=t,this.handle=document.querySelector(e),this.target=document.querySelector(t);const a=localStorage.getItem(`${this.targetId}-dragtop`);"null"!=a&&(this.target.style.top=a,this.target.style.bottom="unset");const s=localStorage.getItem(`${this.targetId}-dragleft`);"null"!=s&&(this.target.style.left=s),this.target.style.right="unset",this.target.addEventListener("opened",(e=>this.updateMaxSizes(e))),this.handle.addEventListener("mousedown",(e=>this.startDrag(e))),this.handle.addEventListener("touchstart",(e=>this.startDrag(e)),{passive:!0}),document.addEventListener("mouseup",(e=>this.stopDrag(e))),document.addEventListener("touchend",(e=>this.stopDrag(e))),window.addEventListener("resize",(e=>this.updateMaxSizes(e))),window.addEventListener("orientationchange",(e=>this.updateMaxSizes(e)))}inBounds(e,t,a,s){return e-t<=0?0:e-t+a>s?s-a:e-t}updateMaxSizes(){let e=this.target.getBoundingClientRect();0!==e.width&&(e.right>document.documentElement.clientWidth&&(this.target.style.left=0),e.bottom>document.documentElement.clientHeight&&(this.target.style.top=0),e=this.target.getBoundingClientRect(),this.target.style.maxHeight=document.documentElement.clientHeight-e.top+"px",this.target.style.maxWidth=document.documentElement.clientWidth-e.left+"px")}startDrag(e){this.draging=!0,this.handle.style.cursor="grabbing",this.target.style.position="fixed";const t=this.target.getBoundingClientRect();switch(e.type){case"mousedown":this.xo=e.clientX-t.left,this.yo=e.clientY-t.top,window.addEventListener("mousemove",(e=>this.doDrag(e)));break;case"touchstart":e.preventDefault(),e.stopPropagation(),this.xo=e.targetTouches[0].clientX-t.left,this.yo=e.targetTouches[0].clientY-t.top,window.addEventListener("touchmove",(e=>this.doDrag(e)))}}doDrag(e){if(this.draging){switch(this.updateMaxSizes(),this.target.style.bottom="unset",e.type){case"mousemove":this.target.style.left=`${this.inBounds(e.clientX,this.xo,this.target.offsetWidth,document.documentElement.clientWidth)}px`,this.target.style.top=`${this.inBounds(e.clientY,this.yo,this.target.offsetHeight,document.documentElement.clientHeight)}px`;break;case"touchmove":e.preventDefault(),e.stopPropagation(),this.target.style.left=`${this.inBounds(e.targetTouches[0].clientX,this.xo,this.target.offsetWidth,document.documentElement.clientWidth)}px`,this.target.style.top=`${this.inBounds(e.targetTouches[0].clientY,this.yo,this.target.offsetHeight,document.documentElement.clientHeight)}px`}this.target.style.bottom="unset",setLocalStorage(`${this.targetId}-dragtop`,this.target.style.top),setLocalStorage(`${this.targetId}-dragleft`,this.target.style.left)}}stopDrag(){this.draging&&(this.draging=!1,this.handle.style.cursor="grab",window.removeEventListener("mousemove",(e=>this.doDrag(e))),window.removeEventListener("touchmove",(e=>this.doDrag(e))))}}document.getElementById("postform")&&new Dragable("#postform-dragHandle","#postform");let imageSourcesList,imageSources=new Set(JSON.parse(localStorage.getItem("hiddenimages")));const toggleAllHidden=e=>imageSources.forEach((t=>toggleSource(t,e))),toggleSource=(e,t)=>{document.querySelectorAll(`img.file-thumb[src="${e}"], img.catalog-thumb[src="${e}"]`).forEach((e=>e.classList[t?"add":"remove"]("vh")));document.querySelectorAll(`a.hide-image[data-src="${e}"]`).forEach((e=>e.textContent=t?__("Show"):__("Hide")))};toggleAllHidden(!0);const toggleHandler=e=>{const t=e.target.dataset.src,a=imageSources.has(t);imageSources[a?"delete":"add"](t),imageSourcesList.value=[...imageSources],setLocalStorage("hiddenimages",JSON.stringify([...imageSources])),toggleSource(t,!a)};Array.from(document.getElementsByClassName("hide-image")).forEach((e=>{e.addEventListener("click",toggleHandler,!1)}));const handleHiddenImages=e=>{if(e.detail.json.files.forEach((e=>{let t="/file/";e.hasThumb?t+=`thumb/${e.hash}${e.thumbextension}`:t+=e.filename,imageSources.has(t)&&toggleSource(t,!0)})),!e.detail.hover){const t=e.detail.post.querySelectorAll(".hide-image");for(let e=0;e<t.length;e++)t[e].addEventListener("click",toggleHandler,!1)}};window.addEventListener("addPost",handleHiddenImages,!1),window.addEventListener("settingsReady",(()=>{imageSourcesList=document.getElementById("hiddenimages-setting"),imageSourcesList.value=[...imageSources];document.getElementById("hiddenimages-clear").addEventListener("click",(()=>{toggleAllHidden(!1),imageSources=new Set,imageSourcesList.value="",setLocalStorage("hiddenimages","[]"),console.log("cleared hidden images list")}),!1)}));let yousList,notificationsEnabled="true"==localStorage.getItem("notifications"),notificationYousOnly="true"==localStorage.getItem("notification-yous-only"),yousEnabled="true"==localStorage.getItem("yous-setting"),savedYous=new Set(JSON.parse(localStorage.getItem("yous")));function clearYousList(){yousEnabled&&toggleAllYous(!1),savedYous=new Set,yousList.value="",setLocalStorage("yous","[]"),console.log("cleared yous")}function toggleAllYous(e){savedYous.forEach((t=>toggleOne(t,e)))}const toggleQuotes=(e,t)=>{e.forEach((e=>{e[t?"setAttribute":"removeAttribute"]("data-label",__("You")),e.classList[t?"add":"remove"]("you")}))},toggleOne=(e,t)=>{const[a,s]=e.split("-"),o=document.querySelector(`[data-board="${a}"][data-post-id="${s}"]`);if(o){const e=o.querySelector(".post-name");e&&(e[t?"setAttribute":"removeAttribute"]("data-label",__("You")),e.classList[t?"add":"remove"]("you"))}const i=document.querySelectorAll(`.quote[href^="/${a}/"][href$="#${s}"]`);i&&toggleQuotes(i,t)},formatNotificationOptions=e=>{const t={body:e.nomarkup?e.nomarkup.substring(0,100):""};if(e.files.length>0){let a;const s=e.spoiler||e.files.some((e=>!0===e.spoiler)),o=e.files.find((e=>!e.spoiler&&(!0===e.hasThumb||e.mimetype.startsWith("image/"))));s&&!o?a="/file/spoiler.png":o&&(a=o.hasThumb?`/file/thumb/${o.hash}${o.thumbextension}`:`/file/${o.filename}`),a&&(t.image=a,t.badge=a,t.icon=a)}return t};yousEnabled&&toggleAllYous(yousEnabled);const yousStorageEventHandler=e=>{if(e.storageArea===localStorage&&"yous"===e.key){const t=[...JSON.parse(e.newValue)];t.forEach((e=>{savedYous.has(e)||(savedYous.add(e),console.log("handle new (you) from other context:",e),toggleOne(e,yousEnabled))})),0===t.length&&(console.log("(you)s were cleared in another tab"),clearYousList()),yousList.value=t.toString()}},handleNewYous=e=>{const t=`${e.detail.json.board}-${e.detail.postId}`,a=window.myPostId==e.detail.postId;if(a){savedYous.add(t);const e=[...savedYous];yousList.value=e.toString(),setLocalStorage("yous",JSON.stringify(e))}savedYous.has(t)&&toggleOne(t,yousEnabled);const s=e.detail.json.quotes.map((t=>`${e.detail.json.board}-${t.postId}`)).filter((e=>savedYous.has(e))).length>0,o=e.detail.json.quotes.concat(e.detail.json.backlinks).map((t=>`${e.detail.json.board}-${t.postId}`)).filter((e=>savedYous.has(e))).map((t=>{const[a,s]=t.split("-");return e.detail.post.querySelectorAll(`.quote[href^="/${a}/"][href$="#${s}"]`)})).reduce(((e,t)=>e.concat(Array.from(t))),[]);if(toggleQuotes(o,yousEnabled),!e.detail.nonotify&&!e.detail.hover&&notificationsEnabled&&!a){if(notificationYousOnly&&!s)return;try{console.log("attempting to send notification",t);const a=e.detail.json,o=formatNotificationOptions(a);new Notification(`${s?"New quote in: ":""}${document.title}`,o)}catch(e){console.log("failed to send notification",e)}}};window.addEventListener("addPost",handleNewYous,!1),window.addEventListener("storage",yousStorageEventHandler,!1),window.addEventListener("updatePostMessage",handleNewYous,!1),window.addEventListener("settingsReady",(()=>{yousList=document.getElementById("youslist-setting"),yousList.value=[...savedYous];document.getElementById("youslist-clear").addEventListener("click",clearYousList,!1);const e=document.getElementById("yous-setting");e.checked=yousEnabled,e.addEventListener("change",(()=>{yousEnabled=!yousEnabled,setLocalStorage("yous-setting",yousEnabled),toggleAllYous(yousEnabled),console.log("toggling yous",yousEnabled)}),!1);const t=document.getElementById("notification-yous-only");t.checked=notificationYousOnly,t.addEventListener("change",(()=>{notificationYousOnly=!notificationYousOnly,setLocalStorage("notification-yous-only",notificationYousOnly),console.log("toggling notification only for yous",yousEnabled)}),!1);const a=document.getElementById("notification-setting");a.checked=notificationsEnabled,a.addEventListener("change",(async()=>{if(notificationsEnabled=!notificationsEnabled,notificationsEnabled){if("granted"!=await Notification.requestPermission())return notificationsEnabled=!1,void(a.checked=!1)}console.log("toggling notifications",notificationsEnabled),setLocalStorage("notifications",notificationsEnabled)}),!1)}));const getFiltersFromLocalStorage=()=>JSON.parse(localStorage.getItem("filters1")).reduce(((e,t)=>(t.type.endsWith("r")?e[t.type].push(new RegExp(t.val,"i")):e[t.type].add(t.val),e)),{single:new Set,fid:new Set,fname:new Set,ftrip:new Set,fsub:new Set,fmsg:new Set,fflag:new Set,fnamer:[],ftripr:[],fsubr:[],fmsgr:[],fflagr:[]});let filtersTable,{single:single,fid:fid,fname:fname,ftrip:ftrip,fsub:fsub,fmsg:fmsg,fflag:fflag,fnamer:fnamer,ftripr:ftripr,fsubr:fsubr,fmsgr:fmsgr,fflagr:fflagr}=getFiltersFromLocalStorage();const updateFiltersTable=()=>{[...filtersTable.children].slice(3).forEach((e=>e.remove())),filtersTable.insertAdjacentHTML("beforeend",pugfilters({filterArr:JSON.parse(localStorage.getItem("filters1"))}));const e=filtersTable.querySelectorAll(".close");for(let t of e){let{type:e,data:a}=t.dataset;e.endsWith("r")&&(a=new RegExp(a,"i")),t.addEventListener("click",(()=>{toggleFilter(e,a)}))}},updateSavedFilters=()=>{setLocalStorage("filters1",JSON.stringify([...[...single].map((e=>({type:"single",val:e}))),...[...fid].map((e=>({type:"fid",val:e}))),...[...ftrip].map((e=>({type:"ftrip",val:e}))),...[...fname].map((e=>({type:"fname",val:e}))),...[...fsub].map((e=>({type:"fsub",val:e}))),...[...fmsg].map((e=>({type:"fmsg",val:e}))),...[...fflag].map((e=>({type:"fflag",val:e}))),...fnamer.map((e=>({type:"fnamer",val:e.source.toString()}))),...ftripr.map((e=>({type:"ftripr",val:e.source.toString()}))),...fsubr.map((e=>({type:"fsubr",val:e.source.toString()}))),...fmsgr.map((e=>({type:"fmsgr",val:e.source.toString()}))),...fflagr.map((e=>({type:"fflagr",val:e.source.toString()})))])),updateFiltersTable()},anyFilterMatches=e=>{const{board:t,postId:a,userId:s,name:o,subject:i,tripcode:n,country:r}=e.dataset,l=e.querySelector(".post-message"),d=l?l.textContent:null,c=r?r.code:null;return single.has(`${t}-${a}`)||fid.has(s)||fname.has(o)||ftrip.has(n)||fsub.has(i)||fmsg.has(d)||fflag.has(c)||fnamer.some((e=>e.test(o)))||ftripr.some((e=>e.test(n)))||fsubr.some((e=>e.test(i)))||fmsgr.some((e=>e.test(d)))||fflagr.some((e=>e.test(c)))},togglePostsHidden=(e,t,a)=>{for(let s of e){const e=!t&&(!anyFilterMatches(s)||a);e?s.classList.remove("hidden"):s.classList.add("hidden"),s.querySelector(".postmenu").children[0].textContent=e?__("Hide"):__("Show")}},getPostsByRegex=(e,t)=>{const a=[];for(let s of document.querySelectorAll(`[${e}]`)){const o=s.getAttribute(e).toString();!0===t.test(o)&&a.push(s)}return a},getPostsByMessage=(e,t=!1)=>[...document.querySelectorAll(`.${isCatalog?"catalog-tile":"post-container"} .post-message`)].filter((a=>t?e.test(a.textContent):a.textContent.includes(e))).map((e=>e.closest("."+(isCatalog?"catalog-tile":"post-container")))),getPostsByFilter=(e,t)=>{let a=[];switch(e){case"single":{const[e,s]=t.split("-"),o=document.querySelector(`[data-board="${e}"][data-post-id="${s}"]`);a=o?[o]:[];break}case"fid":a=document.querySelectorAll(`[data-user-id="${t}"]`);break;case"fname":a=document.querySelectorAll(`[data-name="${CSS.escape(t)}"]`);break;case"fnamer":a=getPostsByRegex("data-name",t);break;case"ftrip":a=document.querySelectorAll(`[data-tripcode="${CSS.escape(t)}"]`);break;case"ftripr":a=getPostsByRegex("data-tripcode",t);break;case"fsub":a=document.querySelectorAll(`[data-subject="${CSS.escape(t)}"]`);break;case"fsubr":a=getPostsByRegex("data-subject",t);break;case"fmsg":a=getPostsByMessage(t);break;case"fmsgr":a=getPostsByMessage(t,!0);break;case"fflag":a=document.querySelectorAll(`[data-flag="${CSS.escape(t)}"]`);break;case"fflagr":a=getPostsByRegex("data-flag",t)}return[...a]},setFilterState=(e,t,a)=>{const s=a?"add":"delete";switch(e){case"single":single[s](t);break;case"fid":fid[s](t);break;case"fname":fname[s](t);break;case"fnamer":fnamer=fnamer.filter((e=>e.source!=t.source)),a&&fnamer.push(t);break;case"ftrip":ftrip[s](t);break;case"ftripr":ftripr=ftripr.filter((e=>e.source!=t.source)),a&&ftripr.push(t);break;case"fsub":fsub[s](t);break;case"fsubr":fsubr=fsubr.filter((e=>e.source!=t.source)),a&&fsubr.push(t);break;case"fmsg":fmsg[s](t);break;case"fmsgr":fmsgr=fmsgr.filter((e=>e.source!=t.source)),a&&fmsgr.push(t);break;case"fflag":fflag[s](t);break;case"fflagr":fflagr=fflagr.filter((e=>e.source!=t.source)),a&&fflagr.push(t)}},toggleFilter=(e,t,a)=>{const s=getPostsByFilter(e,t);setFilterState(e,t,a),togglePostsHidden(s,a,"single"===e),updateSavedFilters()};let actionForm,modalBg,moderatingPost;const cancelModeratePost=e=>{moderatingPost&&(e.preventDefault(),moderatingPost.querySelector(".post-check").checked=!1,moderatingPost.style.zIndex="unset",moderatingPost.classList.contains("op")&&(moderatingPost.style.background="unset"),modalBg.style.display="none",modalBg.style.zIndex=4,actionForm.removeAttribute("open"),moderatingPost=null)},moderatePost=e=>{moderatingPost=e,actionForm.classList.add("floatactions"),actionForm.setAttribute("open","open"),actionForm.style.zIndex=3,e.style.zIndex=3,e.classList.contains("op")&&(e.style.background="var(--post-color)"),modalBg.style.display="unset",modalBg.style.zIndex=3;const t=actionForm.querySelector(".captchafield"),a=e.querySelector(".post-check");Array.from(a.form.elements).filter((e=>"checkedposts"===e.name)).forEach((e=>e.checked=!1)),a.checked=!0,t&&captchaController.loadCaptcha(t)},postMenuChange=function(){const e=this.closest(isCatalog?".catalog-tile":".post-container"),t=e.dataset,a=this.value,s=!e.classList.contains("hidden");let o;switch(this.value="",a){case"single":o=`${t.board}-${t.postId}`;break;case"fid":o=t.userId;break;case"fname":o=t.name;break;case"ftrip":o=t.tripcode;break;case"fsub":o=t.subject;break;case"fflag":o=t.flag;break;case"moderate":return moderatePost(e);case"edit":return window.location=`/${t.board}/manage/editpost/${t.postId}.html`;case"watch":{const a=e.querySelector(".post-message"),s=(t.subject||a&&a.textContent||`#${t.postId}`).substring(0,25);return void threadWatcher.add(t.board,t.postId,{subject:s,unread:0,updatedDate:new Date})}case"playlist":console.log("creating playlist..."),window.dispatchEvent(new CustomEvent("createPlaylist",{detail:{board:t.board,postId:t.postId}}))}toggleFilter(a,o,s)};for(let e of document.getElementsByClassName("postmenu"))e.value="",e.addEventListener("change",postMenuChange,!1);const getHiddenElems=()=>{let e=[];for(let t of single)e=e.concat(getPostsByFilter("single",t));for(let t of fid)e=e.concat(getPostsByFilter("fid",t));for(let t of fname)e=e.concat(getPostsByFilter("fname",t));for(let t of ftrip)e=e.concat(getPostsByFilter("ftrip",t));for(let t of fsub)e=e.concat(getPostsByFilter("fsub",t));for(let t of fmsg)e=e.concat(getPostsByFilter("fmsg",t));for(let t of fflag)e=e.concat(getPostsByFilter("fflag",t));for(let t of fnamer)e=e.concat(getPostsByFilter("fnamer",t));for(let t of ftripr)e=e.concat(getPostsByFilter("ftripr",t));for(let t of fsubr)e=e.concat(getPostsByFilter("fsubr",t));for(let t of fmsgr)e=e.concat(getPostsByFilter("fmsgr",t));for(let t of fflagr)e=e.concat(getPostsByFilter("fflagr",t));return e};togglePostsHidden(getHiddenElems(),!0),window.addEventListener("addPost",(function(e){const t=e.detail.post;if(anyFilterMatches(t)&&t.classList.add("hidden"),e.detail.hover)return;const a=t.querySelector(".postmenu");a.value="",a.addEventListener("change",postMenuChange,!1)})),window.addEventListener("updatePostMessage",(function(e){const t=e.detail.post;anyFilterMatches(t)&&t.classList.add("hidden")})),window.addEventListener("settingsReady",(function(){actionForm=document.getElementById("actionform"),actionForm&&(modalBg=document.querySelector(".modal-bg"),actionForm.firstChild.addEventListener("click",cancelModeratePost),modalBg.addEventListener("click",cancelModeratePost,!1)),filtersTable=document.getElementById("advancedfilters"),updateFiltersTable();const e=document.getElementById("filter-form");e.addEventListener("submit",(t=>{t.preventDefault();const a=e.elements.regex.checked,s=`${e.elements.type.value}${a?"r":""}`,o=a?new RegExp(e.elements.value.value,"i"):e.elements.value.value;console.log("adding filter",s,o),toggleFilter(s,o,!0)}));document.getElementById("filters-clear").addEventListener("click",(()=>{single=new Set,fid=new Set,fname=new Set,ftrip=new Set,fsub=new Set,fmsg=new Set,fflag=new Set,fnamer=[],ftripr=[],fsubr=[],fmsgr=[],fflagr=[],updateFiltersTable(),togglePostsHidden(document.querySelectorAll("."+(isCatalog?"catalog-tile":"post-container")),!1),updateSavedFilters(),console.log("cleared hidden posts")}),!1)}));class ThreadWatcher{init(){this.footer=document.getElementById("bottom"),this.footer&&(this.watchListMap=new Map(JSON.parse(localStorage.getItem("watchlist"))),this.minimised="true"===localStorage.getItem("threadwatcher-minimise"),this.threadMatch=window.location.pathname.match(/^\/(\w+)(?:\/manage)?\/thread\/(\d+)\.html$/),window.addEventListener("storage",(e=>this.storageEventHandler(e))),this.settingsInput=document.getElementById("watchlist-setting"),this.clearButton=document.getElementById("watchlist-clear"),this.clearButton.addEventListener("click",(()=>this.clear()),!1),this.createList({minimised:this.minimised}),this.minimiseButton=this.threadWatcher.firstChild.querySelector(".close"),this.minimiseButton.addEventListener("click",(()=>this.toggleMinimise())),this.isFocused=document.hasFocus(),null!==this.threadMatch&&(window.addEventListener("focus",(()=>this.focusHandler(this.threadMatch[1],this.threadMatch[2]))),window.addEventListener("blur",(()=>this.blurHandler())),!0===this.isFocused&&this.focusHandler(this.threadMatch[1],this.threadMatch[2])),this.refreshInterval=setInterval((()=>this.refresh()),6e4))}refresh(){this.watchListMap.size>0&&console.log("refreshing watchlist");for(let e of this.watchListMap.entries()){const[t,a]=e[0].split("-"),s=e[1];this.fetchThread(t,a,s)}}async fetchThread(e,t,a){let s,o;try{s=await fetch(`/${e}/thread/${t}.json`),o=await s.json()}catch(e){}if(o&&o.replies){const s={...a,subject:(o.subject||o.nomarkup||`#${o.postId}`).substring(0,25)},i=new Date(a.updatedDate),n=o.replies.filter((e=>new Date(e.date)>i));if(n.length>0&&(this.isFocused&&this.threadMatch&&this.threadMatch[1]===e&&this.threadMatch[2]===t?s.unread=0:s.unread+=n.length),s.subject!==a.subject||s.unread!==a.unread){s.updatedDate=new Date;const a=`${e}-${t}`;this.watchListMap.set(a,s),this.updateRow(e,t,s),this.commit()}}else s&&404===s.status&&(console.log("removing 404 thread from watchlist"),this.remove(e,t))}storageEventHandler(e){if(e.storageArea===localStorage&&"watchlist"===e.key){console.log("updating watchlist from another context");const t=new Map(JSON.parse(e.newValue));this.watchListMap.forEach(((e,a)=>{if(!t.has(a)){const[e,t]=a.split("-");this.deleteRow(e,t)}})),t.forEach(((e,t)=>{const[a,s]=t.split("-"),o=this.watchListMap.get(t);o?!o||o.unread===e.unread&&o.subject===e.subject||this.updateRow(a,s,e):this.addRow(a,s,e)})),this.watchListMap=new Map(JSON.parse(e.newValue)),this.setVisibility()}}focusHandler(e,t){this.isFocused=!0;const a=`${e}-${t}`,s=this.watchListMap.get(a);s&&0!==s.unread&&(s.unread=0,s.updatedDate=new Date,this.watchListMap.set(a,s),this.updateRow(e,t,s),this.commit())}blurHandler(){this.isFocused=!1}commit(){const e=[...this.watchListMap];setLocalStorage("watchlist",JSON.stringify(e)),this.settingsInput.value=e,this.setVisibility()}toggleMinimise(){this.minimised=!this.minimised,this.minimiseButton.textContent=this.minimised?"[+]":"[−]",this.threadWatcher.classList.toggle("minimised"),setLocalStorage("threadwatcher-minimise",this.minimised)}setVisibility(){this.threadWatcher&&(this.threadWatcher.style.display=0===this.watchListMap.size?"none":null)}createList(){const e=threadwatcher({minimised:this.minimised});this.footer.insertAdjacentHTML("afterend",e),this.threadWatcher=document.getElementById("threadwatcher"),0===this.watchListMap.size&&(this.threadWatcher.style.display="none"),new Dragable("#threadwatcher-dragHandle","#threadwatcher");for(let e of this.watchListMap.entries()){const[t,a]=e[0].split("-"),s=e[1];this.addRow(t,a,s)}}add(e,t,a){const s=`${e}-${t}`;this.watchListMap.has(s)||(this.watchListMap.set(s,a),this.addRow(e,t,a),this.commit())}remove(e,t){this.deleteRow(e,t),this.watchListMap.delete(`${e}-${t}`),this.commit()}clear(){for(let e of this.watchListMap.entries()){const[t,a]=e[0].split("-"),s=e[1];this.deleteRow(t,a,s)}this.watchListMap=new Map,this.commit()}addRow(e,t,a){const s=null!=this.threadMatch&&this.threadMatch[1]===e&&this.threadMatch[2]===t,o=watchedthread({watchedthread:{board:e,postId:t,...a,isCurrentThread:s}});this.threadWatcher.insertAdjacentHTML("beforeend",o);this.threadWatcher.lastChild.querySelector(".close").addEventListener("click",(()=>this.remove(e,t)))}deleteRow(e,t){this.threadWatcher.querySelector(`[data-id="${e}-${t}"]`).remove()}updateRow(e,t,a){const s=this.threadWatcher.querySelector(`[data-id="${e}-${t}"]`);0===a.unread?s.removeAttribute("data-unread"):s.setAttribute("data-unread",a.unread),s.children[1].textContent=`/${e}/ - ${a.subject}`}}const threadWatcher=new ThreadWatcher;window.addEventListener("settingsReady",(()=>{threadWatcher.init()})),isCatalog&&window.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("catalogfilter");e.value="";e.addEventListener("input",(()=>{for(let e=0;e<renderSheet[rulesKey].length;e++)if(renderSheet[rulesKey][e].selectorText.startsWith(".catalog-tile:not([data-filter*=")){renderSheet.deleteRule(e);break}e.value.length>0&&renderSheet.insertRule(`.catalog-tile:not([data-filter*="${e.value.replace(/["\\]/g,"\\$&").toLowerCase()}"]) { display: none; }`)}),!1);const t={date:(e,t)=>new Date(t.dataset.date)-new Date(e.dataset.date),bump:(e,t)=>e.dataset.bump-t.dataset.bump,replies:(e,t)=>t.dataset.replies-e.dataset.replies},a=document.getElementsByClassName("catalog-tile"),s=document.getElementById("catalogsort");s.value="";s.addEventListener("change",(e=>{var s;s=e.target.value,console.log("sorting catalog",s),Array.from(a).sort(t[s]||(()=>1)).forEach(((e,t)=>{e.style.order=t}))}),!1)}));let relativeTime="true"==localStorage.getItem("relative"),hour24="true"==localStorage.getItem("24hour"),localTime="true"==localStorage.getItem("localtime"),dates=[];const dateElems=document.getElementsByClassName("reltime");for(let e=0;e<dateElems.length;e++)dates.push(dateElems[e]);const YEAR=31536e6,MONTH=2592e6,WEEK=6048e5,DAY=864e5,HOUR=36e5,MINUTE=6e4,relativeTimeString=e=>{let t=Date.now()-new Date(e).getTime(),a=0,s="",o=!1;return t<0&&(t=Math.abs(t),o=!0),t<6e4?__("Now"):(t<357e4?(a=Math.round(t/6e4),s="minute"):t<846e5?(a=Math.round(t/HOUR),s="hour"):t<6.5*DAY?(a=Math.round(t/DAY),s="day"):t<3.5*WEEK?(a=Math.round(t/WEEK),s="week"):t<11.5*MONTH?(a=Math.round(t/MONTH),s="month"):(a=Math.round(t/YEAR),s="year"),__n(`%s ${s} ${o?"from now":"ago"}`,a))},changeDateFormat=e=>{const t={hour12:!hour24};localTime||(t.timeZone=SERVER_TIMEZONE);const a=new Date(e.dateTime).toLocaleString(LANG,t);relativeTime?(e.innerText=relativeTimeString(e.dateTime),e.title=a):(e.innerText=a,e.removeAttribute("title"))},updateDates=()=>{for(let e=0;e<dates.length;e++)changeDateFormat(dates[e])};updateDates(),window.addEventListener("settingsReady",(function(){let e=relativeTime?setInterval(updateDates,6e4):void 0;const t=document.getElementById("24hour-setting");t.checked=hour24,t.addEventListener("change",(()=>{hour24=!hour24,setLocalStorage("24hour",hour24),updateDates(),console.log("toggling 24h time",hour24)}),!1);const a=document.getElementById("localtime-setting");a.checked=localTime,a.addEventListener("change",(()=>{localTime=!localTime,setLocalStorage("localtime",localTime),updateDates(),console.log("toggling local time",localTime)}),!1);const s=document.getElementById("relative-setting");s.checked=relativeTime,s.addEventListener("change",(()=>{relativeTime=!relativeTime,setLocalStorage("relative",relativeTime),updateDates(),relativeTime?e=setInterval(updateDates,6e4):clearInterval(e),console.log("toggling relative time",relativeTime)}),!1)}));const handleDateUpdates=(e,t=!1)=>{const a=e.querySelectorAll(".reltime");for(let e of a)t||dates.push(e),changeDateFormat(e)};window.addEventListener("addPost",(function(e){handleDateUpdates(e.detail.post,e.detail.hover)})),window.addEventListener("showModal",(function(e){handleDateUpdates(e.detail.modal)})),window.ethereum?window.jschanweb3=new Web3(window.ethereum):document.querySelectorAll(".web3").forEach((e=>e.remove()));